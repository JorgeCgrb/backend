rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    match /users/{uid} {
        allow get: if true;
        allow update: if request.auth != null && request.auth.uid == uid;
        
        match /private/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }
    
    match /organizations/{id} {
      allow read: if true;
      allow write: if false;
    }
    
    // Ojocuidao con las colecciones y subcolecciones que se llamen images
    match /{path=**}/images/{imageId} {
      allow read: if true;
    }
    
  	match /seeds/{id} {
      allow read: if true;
      allow create: if request.auth != null && isOrgOwner();
      allow update, delete: if request.auth != null && isSeedOwner();
      
      match /images/{imageId} {
      	allow read: if true;
        allow create: if request.auth != null;
      }
      
      function isOrgOwner() {
      	let org = get(/databases/$(database)/documents/organizations/$(request.resource.data.owner));
        return org == null? false : org.data.owner == request.auth.uid;
      }
      
      function isSeedOwner() {
      	let seed = get(/databases/$(database)/documents/seeds/$(id));
      	let org = get(/databases/$(database)/documents/organizations/$(seed.data.owner));
				return org.data.owner == request.auth.uid;
      }
    }
    
    // TODO Arreglar esto con roles de owner
    match /suggestions/{id} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if true;
    }
    
    // TODO Arreglar esto con rol del ADMIN
    match /reports/{id} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if true;
    }
    
    // TODO Arreglar esto con participantes
    match /chats/{chatId} {
    	allow create: if true;
    	allow read: if true;
      allow update: if true
      
      match /messages/{messageId} {
        allow read: if true;
        allow create: if true;
      }
    }
    
    // Proyectos experimentales
    match /projects/{projectId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && isProjectOwner(projectId);
      
      function isProjectOwner(projId) {
        let project = get(/databases/$(database)/documents/projects/$(projId));
        return project.data.owner == request.auth.uid;
      }
    }
    
    // Membres√≠as de proyectos
    match /project_memberships/{membershipId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
  }
}